import{r as t,h as s,c as i}from"./p-a038ae2f.js";const e=class{constructor(s){t(this,s)}inputHandler(t){this.modelService.setModelValue(t.target.id,t.target.value)}render(){if(this.page&&this.page.components)return this.page.components.map(t=>s(t.tag,Object.assign({"wf-element":!0,onInput:this.inputHandler.bind(this)},t,{context:this.page.context,value:this.modelService.getComponentModelValue(t)})))}};class h{constructor(){this.type=h.type,this.execute=t=>{t.container.page=Object.assign(Object.assign({},this),{context:t})}}static create(t){return Object.assign(new h,t)}}h.type="page-activity";class r{constructor(){this.type=r.type,this.execute=t=>{this.eval(this.expression,t),t.wfService.setNextAction(this.next)}}static create(t){return Object.assign(new r,t)}eval(t,s){return new Function("context","model",t)(s,s.model)}}r.type="code-activity";class c extends r{constructor(){super(...arguments),this.type=c.type,this.execute=t=>{const s=super.eval(`return ${this.left} ${this.equality} ${this.right};`,t);t.wfService.setNextAction(s?this.trueAction:this.falseAction)}}static create(t){return Object.assign(new c,t)}}c.type="decision-activity";class n extends class{constructor(t,s){this.rawUrl=t,this.method=s}get url(){return this.rawUrl}get headers(){return{"Content-Type":"application/json"}}}{constructor(t,s,i){super(t,s),this.modelService=i}get url(){return this.getUrlWithValuesFromModel()}getUrlWithValuesFromModel(){let t=this.rawUrl;return t.match(/{[\w|\.]+}/g).map(this.createValueItem.bind(this)).forEach(s=>t=t.replace(s.key,s.value||"")),t}createValueItem(t){const s=t.substring(1,t.length-1);return{key:t,value:this.modelService.getValue(s,this.modelService.getModel())}}}class a{constructor(){this.type=a.type,this.execute=t=>{const s=new n(this.url,this.method,t.modelService);return t.http.fetch(s,this.mappings).then(()=>t.wfService.setNextAction(this.next))}}static create(t){return Object.assign(new a,t)}}a.type="api-activity";class o{constructor(){this.type=o.type,this.execute=t=>{let s=this.value||"";this.value.startsWith("{")&&this.value.endsWith("}")&&(s=t.modelService.getValue(this.value.substring(1,this.value.length-1),t.model)),t.modelService.setModelValue(this.key,s),t.wfService.setNextAction(this.next)}}static create(t){return Object.assign(new o,t)}}o.type="assign-activity";class u{static linkActivities(t){t.activities.forEach(t=>{const s=u.activities.find(s=>s.type===t.type);s&&s.create&&Object.assign(t,s.create(t))})}}u.activities=[{type:h.type,create:h.create},{type:r.type,create:r.create},{type:c.type,create:c.create},{type:o.type,create:o.create},{type:a.type,create:a.create}];class l{setNextAction(t){this.action=t,this.wfChangeHandler&&this.wfChangeHandler(this.action,this.process)}setProcess(t){this.process=t,this.wfChangeHandler&&this.wfChangeHandler(this.action,this.process)}addActivity(t,s){u.activities.find(s=>s.type===t)||u.activities.push({type:t,create:s})}parse(t){try{const s=JSON.parse(t);return u.linkActivities(s),s}catch(s){return console.log(s),null}}}var d,p,y;!function(t){t.StartLoading="START_LOADING",t.EndLoading="END_LOADING",t.Error="ERROR"}(d||(d={}));class g{constructor(t,s,i){this.messageType=t,this.description=s,this.stack=i}}class w{constructor(t,s,i,e,h){this.model=t,this.modelService=s,this.wfService=i,this.http=e,this.container=h}}!function(t){t.GET="get",t.POST="post",t.PUT="put",t.DELETE="delete",t.PATCH="patch"}(p||(p={})),function(t){t.In="in",t.Out="out",t.InOut="inout"}(y||(y={}));class f{constructor(t){this.modelService=t}async fetch(t,s){const i=await fetch(t.url,this.getConfig(t,s)),e=await i.json();return this.setModelValues(e,s)}getConfig(t,s){return{method:t.method,mode:"cors",headers:t.headers,redirect:"follow",referrer:"no-referrer",body:this.getBody(t,s)}}getBody(t,s){if(t.method===p.GET||t.method===p.DELETE)return null;let i={};const e=this.modelService.getModel();return s.filter(t=>t.direction===y.Out||t.direction===y.InOut).forEach(t=>Object.assign(i,{[t.client]:this.modelService.getValue(t.client,e)})),JSON.stringify(i)}setModelValues(t,s){if(!s||0===s.length)return Object.keys(t).forEach(s=>this.modelService.setModelValue(s,t[s]));s.filter(t=>t.direction===y.Out||t.direction===y.InOut).forEach(s=>this.modelService.setModelValue(s.client,this.modelService.getValue(s.remote,t)))}}class O{constructor(t,s,i){this.wfService=t,this.modelService=s,this.container=i,this.hasError=!1,this.http=new f(this.modelService),this.context=new w({},this.modelService,this.wfService,this.http,this.container)}handle(){this.wfService.wfChangeHandler=this.handleWfChange.bind(this),this.modelService.modelChangedHandler=this.handleModelChanged.bind(this)}handleWfChange(t,s){this.currProcess=s,this.currAction=t||"start",this.executeActivity()}handleModelChanged(t){this.context.model=t}executeActivity(){if(!this.hasActivities())return;const t=this.currProcess.activities.find(t=>t.name===this.currAction),s=this.context.model;this.canExecute(t)&&(this.hasError=!1,this.sendMessage(new g(d.StartLoading,"Loading...")),this.tryExecute(t).then(()=>this.actionExecuted(t,s)).catch(t=>{this.modelService.setModelValue("message",new g(d.EndLoading)),this.handleError(t)}))}async tryExecute(t){try{await t.execute(this.context)}catch(s){this.handleError(s)}}actionExecuted(t,s){this.hasError||(this.sendMessage(new g(d.EndLoading)),this.goToNextAction(t,s))}goToNextAction(t,s){t.components?this.lastAction=this.currAction:this.wfService.setNextAction(s!==this.context.model?this.lastAction:null)}handleError(t){this.hasError=!0,this.sendMessage(new g(d.Error,t.message,t.stack)),console.log("ERROR OCCURED",t),console.dir(t)}hasActivities(){return this.currProcess&&this.currProcess.activities}canExecute(t){return t&&t.execute}sendMessage(t){this.modelService.setModelValue("message",t),this.context.container.wfMessage.emit(t)}}class j{constructor(){this.model={},this.onInput=this.inputHandler.bind(this)}setModelValue(t,s){this.model=this.merge(this.model,t,s),this.modelChangedHandler&&this.modelChangedHandler(this.model)}getComponentModelValue(t){const s=this.getModel();let i;return t&&t.id&&s&&(i=this.getModelValue(t.id)),void 0===i&&t.value&&(i=t.value,this.setModelValue(t.id,i)),i}getModelValue(t){return this.getValue(t,this.getModel())}getModel(){return Object.assign({},this.model)}getValue(t,s){return t.split(".").reduce((t,s)=>t?t[s]:void 0,s)}inputHandler(t){const s=t.currentTarget.closest("[wf-element]");this.setModelValue(s.id,s.value)}merge(t,s,i){let e=Object.assign({},t);return s.split(".").reduce((t,s,e,h)=>(t[s]=e==h.length-1?i:Object.assign({},t[s]),t[s]),e),e}}const v=class{constructor(s){t(this,s),this.wfMessage=i(this,"wfMessage",7)}async addActivity(t,s){this.wfService.addActivity(t,s)}async goto(t){this.wfService.setNextAction(t)}async loadProcess(t){this.page=null,this.wfService.setProcess(t)}async parse(t){return this.wfService.parse(t)}async load(t){"object"==typeof t&&(t=JSON.stringify(t));const s=this.wfService.parse(t);if(s)return this.loadProcess(s)}async componentWillLoad(){this.wfService=new l,this.modelService=new j,this.wfHandler=new O(this.wfService,this.modelService,this),this.wfHandler.handle()}render(){return s("sirius-page",{page:this.page,modelService:this.modelService})}};export{e as sirius_page,v as sirius_wf};