import{r as t,h as s,c as i}from"./p-85f409c3.js";const e=class{constructor(s){t(this,s)}async analyticsHandler(t){const s=e.analyticsService.getPath(t);e.lastPath[0]!==s[0]&&(e.lastPath=s,s.find(t=>t.hasAttribute&&t.hasAttribute("wf-element"))&&(s[0].addEventListener("blur",this.onBlur),e.analyticsService.send("click",s)))}wfMessage(t){e.analyticsService.sendMessage(t)}onBlur(t){e.analyticsService.send("blur",e.lastPath),t.target.removeEventListener("blur",this.onBlur)}};e.lastPath=[null],e.analyticsService=new class{sendMessage(t){this.sendPostMessage(t.detail)}send(t,s){const i=s.find(t=>t.hasAttribute&&t.hasAttribute("wf-element"));if(!i)return;const e=this.createPayload(t,i,s);e&&this.sendPostMessage({type:e.type,process:e.process,activity:e.activity,control:e.control,valueHash:e.valueHash,path:e.wfPath.map(this.getName)})}getPath(t){return t.composedPath(t)}sendPostMessage(t){const s=Object.assign(Object.assign({},t),{timestamp:Date.now()});console.log("ANALYTICS",s),window.postMessage(s,"*")}getName(t){return t.id?t.id:t.page&&t.page.name?t.page.name:""}createPayload(t,s,i){const e=i.filter(t=>t.nodeName&&-1===t.nodeName.indexOf("document-fragment")),h=e.find(t=>"sirius-page"===t.localName);if(!h)return null;const r=Object.assign({},h.page),n=e.slice(0,e.indexOf(h)+1);return r.name?{type:t,process:r.context.wfService.process.name,activity:r.name,control:s.id,valueHash:this.getHashCode(s.value),wfPath:n}:null}getHashCode(t){let s,i=0;if(!t||0===t.length)return i;for(let e=0;e<t.length;e++)s=t.charCodeAt(e),i=(i<<5)-i+s,i|=0;return i}};const h=class{constructor(s){t(this,s)}async inputHandler(t){this.modelService.setModelValue(t.target.id,t.target.value),this.page.isDirty&&await this.page.validate(this.page.context)}renderItem(t){return[s(t.tag,Object.assign({"wf-element":!0,id:t.id,data:t,error:t.error,errorMsg:t.errorMessage,onInput:this.inputHandler.bind(this)},t,{context:this.page.context,value:this.modelService.getComponentModelValue(t),caption:this.modelService.getInterpolatedValue(t.caption)})),t.validators?s("span",null,t.errorMessage):null]}render(){if(this.page&&this.page.components)return this.page.components.map(this.renderItem.bind(this))}static get style(){return"input[wf-element][data-error-style=true]{border:1px solid #000}[wf-element]{margin:0 2px}input[wf-element][error=true][data-error-style=true]{border:1px solid var(--error-color,red);background-color:var(--error-bg-color,pink)}span{display:inline-block;color:var(--error-color,red)}"}};class r{constructor(t,s,i){this.parent=t,this.process=s,this.next=i}}class n extends Error{constructor(){super(...arguments),this.type="ValidationError"}}class c{constructor(t,s){this.context=t,this.component=s}static validate(t,s){const i=new c(t,s).validate();return t.container.page=Object.assign({},t.container.page),i}validate(){return this.setErrorState(null),!this.hasValidators()||this.executeValidators()}hasValidators(){return this.component&&this.component.validators&&this.component.validators.length>0}executeValidators(){for(const t of this.component.validators){const s=c.RegisteredValidators.find(s=>s.name===t.name);if(s&&!s.validate(this.context,this.component,t))return!1}return!0}setErrorState(t){this.component.error=t&&t.length>0,this.component.errorMessage=t}}c.RegisteredValidators=[new class extends class{constructor(t){this.name=t}}{validate(t,s,i){const e=t.modelService.getModelValue(s.id);return null!=e&&null!=e&&0!=e.toString().trim().length||(s.error="true",s.errorMessage=i.message,!1)}}("Required")];class a{constructor(){this.type=a.type,this.execute=t=>{this.context=t,this.isDirty=!1,this.components.filter(t=>t.validators).forEach(t=>{t.error="false",t.errorMessage=""}),setTimeout(this.reload.bind(this),10)},this.validate=t=>new Promise((s,i)=>{const e=this.components.filter(t=>t.validators);let h=!0;for(var r of(this.isDirty=!0,e))h=h&&c.validate(t,r);h?s(!0):i(new n("Validation Failed"))})}static create(t){return Object.assign(new a,t)}reload(){this.context.container.page=null,setTimeout(()=>this.context.container.page=this,15)}}a.type="page-activity";class o{constructor(){this.type=o.type,this.execute=t=>{this.eval(this.expression,t),this.next&&this.next.length>0&&t.wfService.setNextAction(this.next,this)}}static create(t){return Object.assign(new o,t)}eval(t,s){return new Function("context","model",t)(s,s.model)}}o.type="code-activity";class u extends o{constructor(){super(...arguments),this.type=u.type,this.execute=t=>{const s=super.eval(`return ${this.left} ${this.equality} ${this.right};`,t);t.wfService.setNextAction(s?this.trueAction:this.falseAction,this)}}static create(t){return Object.assign(new u,t)}}u.type="decision-activity";class l{constructor(t,s){this.rawUrl=t,this.method=s}get url(){return this.rawUrl}get headers(){return{"Content-Type":"application/json","api-key":this.apiKey}}}class d extends l{constructor(t,s,i){super(t,s),this.modelService=i}get url(){return this.getUrlWithValuesFromModel()}getUrlWithValuesFromModel(){let t=this.rawUrl;return t.match(/{[\w|\.]+}/g).map(this.createValueItem.bind(this)).forEach(s=>t=t.replace(s.key,s.value||"")),t}createValueItem(t){const s=t.substring(1,t.length-1);return{key:t,value:this.modelService.getValue(s,this.modelService.getModel())}}}class y{constructor(){this.type=y.type,this.execute=t=>{const s=new d(this.url,this.method,t.modelService);return t.http.fetch(s,this.mappings).then(()=>t.wfService.setNextAction(this.next,this))}}static create(t){return Object.assign(new y,t)}}y.type="api-activity";class w{constructor(){this.type=w.type,this.execute=t=>{let s=this.value||"";this.value.startsWith("{")&&this.value.endsWith("}")&&(s=t.modelService.getValue(this.value.substring(1,this.value.length-1),t.model)),t.modelService.setModelValue(this.key,s),t.wfService.setNextAction(this.next,this)}}static create(t){return Object.assign(new w,t)}}w.type="assign-activity";class p{constructor(){this.type=p.type,this.execute=t=>t.container.ipc(this.process,this.next)}static create(t){return Object.assign(new p,t)}}p.type="ipc-activity";class g{constructor(){this.type=g.type,this.execute=t=>t.container.completed(t.container.process)}static create(t){return Object.assign(new g,t)}}g.type="completed-activity";class f{constructor(){this.type=f.type,this.execute=t=>{const s=t.container.wfSessionId;t.container.dehydrate(s),-1===this.url.indexOf("?")?document.location.href=`${this.url}?sessionId=${s}`:document.location.href=`${this.url}&sessionId=${s}`}}static create(t){return Object.assign(new f,t)}}f.type="redirect-activity";class x{static linkActivities(t){t.activities.forEach(t=>{const s=x.activities.find(s=>s.type===t.type);s&&s.create&&Object.assign(t,s.create(t))})}}x.activities=[{type:a.type,create:a.create},{type:o.type,create:o.create},{type:u.type,create:u.create},{type:w.type,create:w.create},{type:y.type,create:y.create},{type:p.type,create:p.create},{type:g.type,create:g.create},{type:f.type,create:f.create}];class O{setNextAction(t,s){this.action=t,this.wfChangeHandler&&this.wfChangeHandler(this.action,this.process,s)}setProcess(t){this.process=t}getProcess(){return this.process}addActivity(t,s){x.activities.find(s=>s.type===t)||x.activities.push({type:t,create:s})}parse(t){try{const s=JSON.parse(t);return x.linkActivities(s),s}catch(s){return console.error(s),null}}}var v,m,b;!function(t){t.GET="get",t.POST="post",t.PUT="put",t.DELETE="delete",t.PATCH="patch"}(v||(v={})),function(t){t.In="in",t.Out="out",t.InOut="inout"}(m||(m={}));class I{constructor(t){this.modelService=t}async fetchData(t,s=null){return this.fetch(t,null,s,!1)}async fetch(t,s=null,i=null,e=!0){const h=await fetch(t.url,this.getConfig(t,s,i)),r=await h.json();return this.modelService&&e?this.setModelValues(r,s):r}getConfig(t,s,i=null){return{method:t.method,mode:"cors",headers:t.headers,redirect:"follow",referrer:"no-referrer",body:i?JSON.stringify(i):this.getBody(t,s)}}getBody(t,s){if(t.method===v.GET||t.method===v.DELETE)return null;let i={};const e=this.modelService.getModel();return s.filter(t=>t.direction===m.Out||t.direction===m.InOut).forEach(t=>Object.assign(i,{[t.client]:this.modelService.getValue(t.client,e)})),JSON.stringify(i)}setModelValues(t,s){if(!s||0===s.length)return Object.keys(t).forEach(s=>this.modelService.setModelValue(s,t[s]));s.filter(t=>t.direction===m.Out||t.direction===m.InOut).forEach(s=>this.modelService.setModelValue(s.client,this.modelService.getValue(s.remote,t)))}}class j{constructor(){this.model={},this.onInput=this.inputHandler.bind(this)}setModelValue(t,s){this.model=this.merge(this.model,t,s),this.modelChangedHandler&&this.modelChangedHandler(this.model)}getComponentModelValue(t){const s=this.getModel();let i;return t&&t.id&&s&&(i=this.getModelValue(t.id)),void 0===i&&t.value&&(i=t.value,this.setModelValue(t.id,i)),i}getModelValue(t){return this.getValue(t,this.getModel())}getInterpolatedValue(t){if(!t)return t;const s=t.match(/\{\{(?:(\w|\.)+)\}\}/g);return s&&0!==s.length?s.reduce((t,s)=>this.replaceAll(t,s),t):t}getModel(){return Object.assign({},this.model)}setModel(t){this.model=Object.assign({},t)}getValue(t,s){return t.split(".").reduce((t,s)=>t?t[s]:void 0,s)}replaceAll(t,s){const i=this.getModelValue(s.substring(2,s.length-2));return t.replace(s,i)}inputHandler(t){const s=t.currentTarget.closest("[wf-element]");this.setModelValue(s.id,s.value)}merge(t,s,i){if(!s)return;let e=Object.assign({},t);return s.split(".").reduce((t,s,e,h)=>(t[s]=e==h.length-1?i:Object.assign({},t[s]),t[s]),e),e}}class S{setItem(t,s){sessionStorage.setItem(t,JSON.stringify(s))}getItem(t){const s=sessionStorage.getItem(t);return s?JSON.parse(s):null}clear(){sessionStorage.clear()}}!function(t){t.StartLoading="START_LOADING",t.EndLoading="END_LOADING",t.Error="ERROR",t.ValidationError="VALIDATION_ERROR",t.Workflow_Changing="WORKFLOW_CHANGING",t.Workflow_Changed="WORKFLOW_CHANGED"}(b||(b={}));class _{constructor(t,s,i){this.messageType=t,this.description=s,this.stack=i}}class N{constructor(t,s,i,e,h){this.model=t,this.modelService=s,this.wfService=i,this.http=e,this.container=h}}class A{constructor(t,s,i,e){this.http=t,this.wfService=s,this.modelService=i,this.container=e,this.hasError=!1,this.context=new N({},this.modelService,this.wfService,this.http,this.container)}handle(){this.wfService.wfChangeHandler=this.handleWfChange.bind(this),this.modelService.modelChangedHandler=this.handleModelChanged.bind(this)}handleWfChange(t,s,i){this.hasError=!1,this.currProcess=s,this.currAction=t||"start",setTimeout(()=>{this.setWorkflowStatus(),this.sendMessage(new _(b.Workflow_Changing,this.getWorkflowStatus())),this.executeActivity(i)},10)}handleModelChanged(t){this.context.model=t}executeActivity(t){if(!this.hasActivities())return;const s=this.currProcess.activities.find(t=>t.name===this.currAction);this.canExecute(s)&&(this.hasError=!1,this.sendMessage(new _(b.StartLoading,"Loading...")),this.validate(t).then(()=>s.execute(this.context)).then(()=>this.actionExecuted()).catch(t=>this.handleError(t)))}async validate(t){if(this.shouldSkipValidate(t))return!0;const s=this.currProcess.activities.find(t=>t.name===this.lastAction);return s&&s.validate?s.validate(this.context):void 0}shouldSkipValidate(t){return t&&t.data&&t.data.noValidate||this.currAction===this.lastAction}actionExecuted(){this.sendMessage(new _(b.EndLoading)),this.sendMessage(new _(b.Workflow_Changed,this.getWorkflowStatus())),this.hasError||(this.lastAction=this.currAction)}handleError(t){this.hasError=!0,this.sendMessage(new _(b.EndLoading)),this.modelService.setModelValue("message",new _(b.EndLoading,t.message)),this.sendMessage(new _(t instanceof n?b.ValidationError:b.Error,t.message,t.stack)),this.sendMessage(new _(b.Workflow_Changed,this.getWorkflowStatus()))}hasActivities(){return this.currProcess&&this.currProcess.activities}canExecute(t){return t&&t.execute}sendMessage(t){const s=Object.assign(Object.assign({},t),{process:this.wfProcess,activity:this.wfAction,wfSessionId:this.context.container.wfSessionId});this.modelService.setModelValue("message",s),this.context.container.wfMessage.emit(s)}setWorkflowStatus(){this.wfAction=this.currAction,this.wfProcess=this.currProcess.name}getWorkflowStatus(){return JSON.stringify({process:this.wfProcess,activity:this.wfAction})}}class M{constructor(t){this.http=t}load(t){const s=new l(`${this.baseUrl}\\${t}`,v.GET);return s.apiKey=this.apiKey,this.http.fetchData(s)}}const E=class{constructor(s){t(this,s),this.ipcHistory=[],this.wfMessage=i(this,"wfMessage",7)}validateName(t,s){t!==s&&""!==t&&this.loadUrl(t)}async addActivity(t,s){this.wfService.addActivity(t,s)}async goto(t){this.wfService.setNextAction(t,this)}async loadProcess(t,s="start"){"object"==typeof t&&(t=JSON.stringify(t));const i=this.wfService.parse(t);i&&(this.page=null,this.wfService.setProcess(i),this.goto(s))}async loadUrl(t,s="start"){try{return await this.loadProcess(await this.wfLoaderHandler.load(t),s),this.process=t,this.wfService.getProcess()}catch(i){}}async hydrate(t,s,i="start"){this.wfSessionId=s;const e=this.persistance.getItem(`${s}_IPC`)||[],h=this.persistance.getItem(`${s}_MODEL`)||this.modelService.getModel();this.loadUrl(t,i),this.ipcHistory=e,this.modelService.setModel(h)}async dehydrate(t){this.persistance.clear(),this.persistance.setItem(`${t}_IPC`,this.ipcHistory),this.persistance.setItem(`${t}_MODEL`,this.modelService.getModel())}async ipc(t,s=null){try{this.ipcHistory.push(new r(this.process,t,s)),this.persistance.setItem("WF_SIRIUS_IPC",this.ipcHistory),await this.loadUrl(t,"start")}catch(i){}}async completed(t){const s=this.ipcHistory.pop();if(this.persistance.setItem("WF_SIRIUS_IPC",this.ipcHistory),!s||s.process!==t)return this.ipcHistory=[],void this.persistance.setItem("WF_SIRIUS_IPC",this.ipcHistory);try{await this.loadUrl(s.parent,s.next||"start")}catch(i){}}async componentWillLoad(){this.persistance=new S,this.wfSessionId=this.wfSessionId||this.UUID(),this.wfService=new O,this.modelService=new j,this.http=new I(this.modelService),this.wfHandler=new A(this.http,this.wfService,this.modelService,this),this.wfHandler.handle(),this.wfLoaderHandler=new M(this.http),this.wfLoaderHandler.apiKey=this.apiKey,this.wfLoaderHandler.baseUrl=this.baseUrl,this.process&&this.loadUrl(this.process)}UUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var s=16*Math.random()|0;return("x"==t?s:3&s|8).toString(16)}))}render(){return s("sirius-page",{page:this.page,modelService:this.modelService})}static get watchers(){return{process:["validateName"]}}};export{e as sirius_analytics,h as sirius_page,E as sirius_wf};