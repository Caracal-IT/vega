var __extends=this&&this.__extends||function(){var t=function(e,n){t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)if(e.hasOwnProperty(n))t[n]=e[n]};return t(e,n)};return function(e,n){t(e,n);function r(){this.constructor=e}e.prototype=n===null?Object.create(n):(r.prototype=n.prototype,new r)}}();var __awaiter=this&&this.__awaiter||function(t,e,n,r){function i(t){return t instanceof n?t:new n((function(e){e(t)}))}return new(n||(n=Promise))((function(n,o){function c(t){try{u(r.next(t))}catch(e){o(e)}}function s(t){try{u(r["throw"](t))}catch(e){o(e)}}function u(t){t.done?n(t.value):i(t.value).then(c,s)}u((r=r.apply(t,e||[])).next())}))};var __generator=this&&this.__generator||function(t,e){var n={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},r,i,o,c;return c={next:s(0),throw:s(1),return:s(2)},typeof Symbol==="function"&&(c[Symbol.iterator]=function(){return this}),c;function s(t){return function(e){return u([t,e])}}function u(c){if(r)throw new TypeError("Generator is already executing.");while(n)try{if(r=1,i&&(o=c[0]&2?i["return"]:c[0]?i["throw"]||((o=i["return"])&&o.call(i),0):i.next)&&!(o=o.call(i,c[1])).done)return o;if(i=0,o)c=[c[0]&2,o.value];switch(c[0]){case 0:case 1:o=c;break;case 4:n.label++;return{value:c[1],done:false};case 5:n.label++;i=c[1];c=[0];continue;case 7:c=n.ops.pop();n.trys.pop();continue;default:if(!(o=n.trys,o=o.length>0&&o[o.length-1])&&(c[0]===6||c[0]===2)){n=0;continue}if(c[0]===3&&(!o||c[1]>o[0]&&c[1]<o[3])){n.label=c[1];break}if(c[0]===6&&n.label<o[1]){n.label=o[1];o=c;break}if(o&&n.label<o[2]){n.label=o[2];n.ops.push(c);break}if(o[2])n.ops.pop();n.trys.pop();continue}c=e.call(t,n)}catch(s){c=[6,s];i=0}finally{r=o=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:true}}};System.register(["./p-ca871ef5.system.js"],(function(t){"use strict";var e,n,r;return{setters:[function(t){e=t.r;n=t.h;r=t.c}],execute:function(){var i=t("sirius_page",function(){function t(t){e(this,t)}t.prototype.inputHandler=function(t){this.modelService.setModelValue(t.target["id"],t.target["value"])};t.prototype.render=function(){var t=this;var e=function(e){return n(e.tag,Object.assign({"wf-element":true,onInput:t.inputHandler.bind(t)},e,{context:t.page["context"],value:t.modelService.getComponentModelValue(e)}))};if(this.page&&this.page.components)return this.page.components.map(e)};return t}());var o=function(){function t(){var e=this;this.type=t.type;this.execute=function(t){t.container.page=Object.assign(Object.assign({},e),{context:t})}}t.create=function(e){return Object.assign(new t,e)};return t}();o.type="page-activity";var c=function(){function t(){var e=this;this.type=t.type;this.execute=function(t){e.eval(e.expression,t);t.wfService.setNextAction(e.next)}}t.create=function(e){return Object.assign(new t,e)};t.prototype.eval=function(t,e){var n=new Function("context","model",t);return n(e,e.model)};return t}();c.type="code-activity";var s=function(t){__extends(e,t);function e(){var n=t.apply(this,arguments)||this;n.type=e.type;n.execute=function(e){var r="return "+n.left+" "+n.equality+" "+n.right+";";var i=t.prototype.eval.call(n,r,e);if(i)e.wfService.setNextAction(n.trueAction);else e.wfService.setNextAction(n.falseAction)};return n}e.create=function(t){return Object.assign(new e,t)};return e}(c);s.type="decision-activity";var u=function(){function t(t,e){this.rawUrl=t;this.method=e}Object.defineProperty(t.prototype,"url",{get:function(){return this.rawUrl},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"headers",{get:function(){return{"Content-Type":"application/json"}},enumerable:true,configurable:true});return t}();var a=function(t){__extends(e,t);function e(e,n,r){var i=t.call(this,e,n)||this;i.modelService=r;return i}Object.defineProperty(e.prototype,"url",{get:function(){return this.getUrlWithValuesFromModel()},enumerable:true,configurable:true});e.prototype.getUrlWithValuesFromModel=function(){var t=this.rawUrl;t.match(/{[\w|\.]+}/g).map(this.createValueItem.bind(this)).forEach((function(e){return t=t.replace(e.key,e.value||"")}));return t};e.prototype.createValueItem=function(t){var e=t.substring(1,t.length-1);var n=this.modelService.getValue(e,this.modelService.getModel());return{key:t,value:n}};return e}(u);var f=function(){function t(){var e=this;this.type=t.type;this.execute=function(t){var n=new a(e.url,e.method,t.modelService);return t.http.fetch(n,e.mappings).then((function(){return t.wfService.setNextAction(e.next)}))}}t.create=function(e){return Object.assign(new t,e)};return t}();f.type="api-activity";var h=function(){function t(){var e=this;this.type=t.type;this.execute=function(t){var n=e.value||"";if(e.value.startsWith("{")&&e.value.endsWith("}"))n=t.modelService.getValue(e.value.substring(1,e.value.length-1),t.model);t.modelService.setModelValue(e.key,n);t.wfService.setNextAction(e.next)}}t.create=function(e){return Object.assign(new t,e)};return t}();h.type="assign-activity";var l=function(){function t(){}t.linkActivities=function(e){e.activities.forEach((function(e){var n=t.activities.find((function(t){return t.type===e.type}));if(n&&n.create)Object.assign(e,n.create(e))}))};return t}();l.activities=[{type:o.type,create:o.create},{type:c.type,create:c.create},{type:s.type,create:s.create},{type:h.type,create:h.create},{type:f.type,create:f.create}];var p=function(){function t(){}t.prototype.setNextAction=function(t){this.action=t;if(this.wfChangeHandler)this.wfChangeHandler(this.action,this.process)};t.prototype.setProcess=function(t){this.process=t;if(this.wfChangeHandler)this.wfChangeHandler(this.action,this.process)};t.prototype.addActivity=function(t,e){var n=l.activities.find((function(e){return e.type===t}));if(!n)l.activities.push({type:t,create:e})};t.prototype.parse=function(t){try{var e=JSON.parse(t);l.linkActivities(e);return e}catch(n){console.log(n);return null}};return t}();var d;(function(t){t["StartLoading"]="START_LOADING";t["EndLoading"]="END_LOADING";t["Error"]="ERROR"})(d||(d={}));var v=function(){function t(t,e,n){this.messageType=t;this.description=e;this.stack=n}return t}();var y=function(){function t(t,e,n,r,i){this.model=t;this.modelService=e;this.wfService=n;this.http=r;this.container=i}return t}();var g;(function(t){t["GET"]="get";t["POST"]="post";t["PUT"]="put";t["DELETE"]="delete";t["PATCH"]="patch"})(g||(g={}));var m;(function(t){t["In"]="in";t["Out"]="out";t["InOut"]="inout"})(m||(m={}));var w=function(){function t(t){this.modelService=t}t.prototype.fetch=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n,r;return __generator(this,(function(i){switch(i.label){case 0:return[4,fetch(t.url,this.getConfig(t,e))];case 1:n=i.sent();return[4,n.json()];case 2:r=i.sent();return[2,this.setModelValues(r,e)]}}))}))};t.prototype.getConfig=function(t,e){return{method:t.method,mode:"cors",headers:t.headers,redirect:"follow",referrer:"no-referrer",body:this.getBody(t,e)}};t.prototype.getBody=function(t,e){var n=this;if(t.method===g.GET||t.method===g.DELETE)return null;var r={};var i=this.modelService.getModel();e.filter((function(t){return t.direction===m.Out||t.direction===m.InOut})).forEach((function(t){var e;return Object.assign(r,(e={},e[t.client]=n.modelService.getValue(t.client,i),e))}));return JSON.stringify(r)};t.prototype.setModelValues=function(t,e){var n=this;if(!e||e.length===0)return Object.keys(t).forEach((function(e){return n.modelService.setModelValue(e,t[e])}));e.filter((function(t){return t.direction===m.Out||t.direction===m.InOut})).forEach((function(e){return n.modelService.setModelValue(e.client,n.modelService.getValue(e.remote,t))}))};return t}();var _=function(){function t(t,e,n){this.wfService=t;this.modelService=e;this.container=n;this.hasError=false;this.http=new w(this.modelService);this.context=new y({},this.modelService,this.wfService,this.http,this.container)}t.prototype.handle=function(){this.wfService.wfChangeHandler=this.handleWfChange.bind(this);this.modelService.modelChangedHandler=this.handleModelChanged.bind(this)};t.prototype.handleWfChange=function(t,e){this.currProcess=e;this.currAction=t||"start";this.executeActivity()};t.prototype.handleModelChanged=function(t){this.context.model=t};t.prototype.executeActivity=function(){var t=this;if(!this.hasActivities())return;var e=this.currProcess.activities.find((function(e){return e.name===t.currAction}));var n=this.context.model;if(this.canExecute(e)){this.hasError=false;this.sendMessage(new v(d.StartLoading,"Loading..."));this.tryExecute(e).then((function(){return t.actionExecuted(e,n)})).catch((function(e){t.modelService.setModelValue("message",new v(d.EndLoading));t.handleError(e)}))}};t.prototype.tryExecute=function(t){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(n){switch(n.label){case 0:n.trys.push([0,2,,3]);return[4,t.execute(this.context)];case 1:n.sent();return[3,3];case 2:e=n.sent();this.handleError(e);return[3,3];case 3:return[2]}}))}))};t.prototype.actionExecuted=function(t,e){if(this.hasError)return;this.sendMessage(new v(d.EndLoading));this.goToNextAction(t,e)};t.prototype.goToNextAction=function(t,e){if(t.components)this.lastAction=this.currAction;else if(e!==this.context.model)this.wfService.setNextAction(this.lastAction);else this.wfService.setNextAction(null)};t.prototype.handleError=function(t){this.hasError=true;this.sendMessage(new v(d.Error,t.message,t.stack));console.log("ERROR OCCURED",t);console.dir(t)};t.prototype.hasActivities=function(){return this.currProcess&&this.currProcess.activities};t.prototype.canExecute=function(t){return t&&t.execute};t.prototype.sendMessage=function(t){this.modelService.setModelValue("message",t);this.context.container.wfMessage.emit(t)};return t}();var S=function(){function t(){this.model={};this.onInput=this.inputHandler.bind(this)}t.prototype.setModelValue=function(t,e){this.model=this.merge(this.model,t,e);if(this.modelChangedHandler)this.modelChangedHandler(this.model)};t.prototype.getComponentModelValue=function(t){var e=this.getModel();var n;if(t&&t.id&&e)n=this.getModelValue(t.id);if(n===undefined&&t.value){n=t.value;this.setModelValue(t.id,n)}return n};t.prototype.getModelValue=function(t){return this.getValue(t,this.getModel())};t.prototype.getModel=function(){return Object.assign({},this.model)};t.prototype.getValue=function(t,e){return t.split(".").reduce((function(t,e){return t?t[e]:undefined}),e)};t.prototype.inputHandler=function(t){var e=t.currentTarget;var n=e.closest("[wf-element]");this.setModelValue(n.id,n["value"])};t.prototype.merge=function(t,e,n){var r=Object.assign({},t);e.split(".").reduce((function(t,e,r,i){t[e]=r==i.length-1?n:Object.assign({},t[e]);return t[e]}),r);return r};return t}();var b=t("sirius_wf",function(){function t(t){e(this,t);this.wfMessage=r(this,"wfMessage",7)}t.prototype.addActivity=function(t,e){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){this.wfService.addActivity(t,e);return[2]}))}))};t.prototype.goto=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){this.wfService.setNextAction(t);return[2]}))}))};t.prototype.loadProcess=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){this.page=null;this.wfService.setProcess(t);return[2]}))}))};t.prototype.parse=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){return[2,this.wfService.parse(t)]}))}))};t.prototype.load=function(t){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(n){if(typeof t==="object")t=JSON.stringify(t);e=this.wfService.parse(t);if(!e)return[2];return[2,this.loadProcess(e)]}))}))};t.prototype.componentWillLoad=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){this.wfService=new p;this.modelService=new S;this.wfHandler=new _(this.wfService,this.modelService,this);this.wfHandler.handle();return[2]}))}))};t.prototype.render=function(){return n("sirius-page",{page:this.page,modelService:this.modelService})};return t}())}}}));